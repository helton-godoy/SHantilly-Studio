name: Package - Studio Deb and Apps

on:
  release:
    types: [published]

jobs:
  package:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Studio
        uses: actions/checkout@v4
        with:
          path: SHantilly-Studio

      - name: Checkout Core (Dependency)
        uses: actions/checkout@v4
        with:
          repository: helton-godoy/SHantilly
          path: SHantilly

      - name: Install packaging dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgl1-mesa-dev libx11-dev libxkbcommon-dev libfontconfig1-dev libdbus-1-dev libicu-dev build-essential

      - name: Cache vcpkg
        uses: actions/cache@v4
        with:
          path: |
            ${{ github.workspace }}/SHantilly-Studio/vcpkg
            ${{ github.workspace }}/SHantilly-Studio/vcpkg_installed
          key: ${{ runner.os }}-studio-vcpkg-${{ hashFiles('SHantilly-Studio/vcpkg.json') }}

      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgJsonGlob: 'SHantilly-Studio/vcpkg.json'

      - name: Configure and Build
        run: |
          cmake -B build -S SHantilly-Studio \
            -DCMAKE_TOOLCHAIN_FILE=${VCPKG_ROOT}/scripts/buildsystems/vcpkg.cmake \
            -DSHANTILLY_ROOT=${{ github.workspace }}/SHantilly \
            -DCMAKE_BUILD_TYPE=Release
          cmake --build build -j$(nproc)

      - name: Create Packages
        run: |
          cd build
          cpack -G DEB

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: shantilly-studio-deb
          path: build/*.deb

      - name: Upload .deb to Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: build/*.deb
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
